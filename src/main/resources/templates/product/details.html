<!DOCTYPE html>
<html lang="pt-br" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${product.name} + ' - RPG Market'">Detalhes do Item - RPG Market</title>
    <style>
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); color: #28a745; }
            100% { transform: scale(1); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }
        
        .bid-success {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .current-bid-updated {
            animation: glow 2s ease-in-out;
        }
        
        .bid-form {
            transition: all 0.3s ease;
        }
        
        .bid-form:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        .auction-timer {
            background: linear-gradient(135deg, #FF6B6B 0%, #EE5A24 100%);
            border-radius: 10px;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .product-price {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
        }
        
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 2rem;
        }
        
        .bid-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            max-width: 350px;
        }
        
        /* Estilos para o modal de confirmação - Tema RPG */
        .text-gold {
            color: #FFD700 !important;
        }
        
        .border-gold {
            border-color: #FFD700 !important;
        }
        
        .modal-content {
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }
        
        .rpg-font {
            font-family: 'MedievalSharp', serif;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            color: #000;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }
        
        .modal-header, .modal-footer {
            background: rgba(255, 215, 0, 0.05);
        }
    </style>
</head>
<body>    <div layout:fragment="content">
        <!-- Notification container -->
        <div id="bidNotifications" class="bid-notification"></div>
        
        <!-- Sobreposição de carregamento -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p class="mt-2">Processando seu lance...</p>
            </div>
        </div>
        
        <!-- Alerta para produtos vendidos -->
        <div th:if="${product.status.name() == 'SOLD' or product.status.name() == 'AUCTION_ENDED'}" 
             class="alert alert-warning alert-dismissible fade show border-warning mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fs-3 me-3 text-warning"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-1">
                        <i class="fas fa-check-circle me-2"></i>Item já foi vendido
                    </h5>
                    <p class="mb-0">
                        Este item não está mais disponível para compra. 
                        <span th:if="${isOwner}">Você pode visualizar os detalhes pois é o vendedor deste item.</span>
                        <span th:unless="${isOwner}">Explore outros itens similares em nosso marketplace.</span>
                    </p>
                </div>
                <div th:unless="${isOwner}">
                    <a href="/mercado" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-search me-1"></i>Ver outros itens
                    </a>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="rpg-font" th:text="${product.name}">Nome do Item</h1>
            <div>
                <a th:href="@{/mercado}" class="btn btn-outline-dark">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao Mercado
                </a>
            </div>
        </div>
        
        <div class="row">
            <!-- Coluna da Imagem e Detalhes -->
            <div class="col-lg-8 mb-4">
                <div class="card border-gold h-100">
                    <div class="row g-0">                        <div class="col-md-6">
                            <div class="product-img-container h-100">
                                <img th:src="${product.imageUrl != null ? '/images/' + product.imageUrl : '/images/default-product.jpg'}" 
                                     class="img-fluid rounded-start h-100 w-100 object-fit-cover product-img" 
                                     alt="Imagem do Produto"
                                     th:data-full-image="${product.imageUrl != null ? '/images/' + product.imageUrl : '/images/default-product.jpg'}"
                                     onclick="openImageModal(this)"
                                     onerror="this.src='/images/default-product.jpg';">
                                <span class="badge product-category-badge bg-dark" 
                                      th:text="${product.category != null ? product.category.displayName : 'Sem categoria'}">Categoria</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card-body">
                                <!-- Nome, Tipo e Status -->
                                <h5 class="card-title rpg-font" th:text="${product.name}">Nome do Item</h5>
                                <p class="mb-2">
                                    <span th:if="${product.type.name() == 'DIRECT_SALE'}" class="badge bg-primary">Venda Direta</span>
                                    <span th:if="${product.type.name() == 'AUCTION'}" class="badge bg-danger">Leilão</span>
                                    
                                    <span th:if="${product.status.name() == 'AVAILABLE'}" class="badge bg-success">Disponível</span>
                                    <span th:if="${product.status.name() == 'SOLD'}" class="badge bg-secondary">Vendido</span>
                                    <span th:if="${product.status.name() == 'AUCTION_ACTIVE'}" class="badge bg-warning">Leilão Ativo</span>
                                    <span th:if="${product.status.name() == 'AUCTION_ENDED'}" class="badge bg-secondary">Leilão Encerrado</span>
                                    <span th:if="${product.status.name() == 'CANCELED'}" class="badge bg-danger">Cancelado</span>
                                </p>
                                
                                <!-- Contador de Leilão -->
                                <div th:if="${product.type.name() == 'AUCTION' and product.status.name() == 'AUCTION_ACTIVE'}" class="alert alert-warning mb-3">
                                    <input type="hidden" id="endDate" 
                                           th:value="${#temporals.format(product.auctionEndDate, 'yyyy-MM-dd HH:mm:ss')}">
                                    <i class="fas fa-hourglass-half me-2"></i>Termina em: 
                                    <span id="countdown">--h --m</span>
                                </div>
                                
                                <!-- Descrição -->
                                <div class="mb-3">
                                    <h6 class="fw-bold">Descrição:</h6>
                                    <p class="card-text" 
                                       th:text="${product.description}">Descrição do produto</p>
                                </div>
                                
                                <!-- Detalhes do Vendedor -->
                                <div class="mb-3">
                                    <h6 class="fw-bold">Vendido por:</h6>
                                    <div class="d-flex align-items-center">
                                        <img th:if="${product.seller.profileImageUrl}" 
                                             th:src="@{/images/{name}(name=${product.seller.profileImageUrl})}" 
                                             alt="Foto do Vendedor" class="rounded-circle me-2" 
                                             style="width:40px;height:40px;object-fit:cover;">
                                        <img th:unless="${product.seller.profileImageUrl}" 
                                             th:src="@{/images/default-user.jpg}" 
                                             alt="Foto do Vendedor" class="rounded-circle me-2" 
                                             style="width:40px;height:40px;">
                                        <div>
                                            <p class="mb-0" th:text="${product.seller.username}">Vendedor</p>
                                            <small class="text-muted">Nível <span th:text="${product.seller.level}">1</span></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Coluna de Preço e Ações -->
            <div class="col-lg-4 mb-4">
                <div class="card border-gold">
                    <div class="card-header bg-dark text-light">
                        <h3 class="rpg-font mb-0">
                            <i class="fas fa-coins me-2"></i>Preço e Ações
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Se for venda direta -->
                        <div th:if="${product.type.name() == 'DIRECT_SALE' and product.status.name() == 'AVAILABLE'}" class="text-center mb-4">
                            <h2 class="product-price display-6 mb-3" 
                                th:text="${'$' + #numbers.formatDecimal(product.price, 0, 'POINT', 2, 'COMMA')}">
                                $99.99
                            </h2>
                            <!-- Formulário para compra -->
                            <form th:action="@{/item/{id}/comprar(id=${product.id})}" method="post" sec:authorize="isAuthenticated()">
                                <button type="submit" class="btn btn-gold btn-lg w-100 mb-2">
                                    <i class="fas fa-shopping-cart me-2"></i>Comprar Agora
                                </button>
                            </form>
                            <!-- Link para editar se o vendedor -->
                            <div th:if="${#authentication.name == product.seller.username}" class="d-grid gap-2">
                                <a th:href="@{/item/{id}/editar(id=${product.id})}" 
                                   class="btn btn-outline-primary btn-lg w-100 mb-2">
                                    <i class="fas fa-edit me-2"></i>Editar Item
                                </a>
                                
                                <!-- Botão para excluir o item -->
                                <form th:action="@{/item/{id}/excluir(id=${product.id})}" method="post" 
                                      onsubmit="return confirm('Tem certeza que deseja excluir este anúncio? Esta ação não pode ser desfeita.');">
                                    <!-- Adicionar token CSRF -->
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    
                                    <button type="submit" class="btn btn-danger btn-lg w-100">
                                        <i class="fas fa-trash-alt me-2"></i>Excluir Anúncio
                                    </button>
                                </form>
                            </div>
                            <!-- Alert para usuários não autenticados -->
                            <div sec:authorize="!isAuthenticated()" class="alert alert-info">
                                <a th:href="@{/login}" class="alert-link">Entre</a> ou 
                                <a th:href="@{/aventureiro/registrar}" class="alert-link">registre-se</a> para comprar este item.
                            </div>
                        </div>
                        
                        <!-- Se for leilão -->
                        <div th:if="${product.type.name() == 'AUCTION' and product.status.name() == 'AUCTION_ACTIVE'}" class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Exibição do lance atual -->
                                <div>
                                    <h6>Lance Atual:</h6>
                                    <h2 class="product-price mb-0" 
                                        th:text="${'$' + #numbers.formatDecimal((product.price != null ? product.price : 0), 0, 'POINT', 2, 'COMMA')}">
                                        $99.99
                                    </h2>
                                </div>
                                <div th:if="${product.buyNowPrice != null}">
                                    <h6>Compre Agora:</h6>
                                    <h3 class="text-success mb-0" 
                                        th:text="${'$' + #numbers.formatDecimal(product.buyNowPrice, 0, 'POINT', 2, 'COMMA')}">
                                        $199.99
                                    </h3>
                                </div>
                            </div>                            <!-- Formulário para dar lance com modal -->
                            <div class="bid-form">
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="fas fa-coins text-warning"></i></span>
                                    <input type="number" class="form-control" id="bidAmount"
                                           th:min="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1)}" 
                                           step="0.01"
                                           th:value="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1)}" 
                                           required>
                                </div>
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Lance mínimo: $<span id="minBidAmount" th:text="${#numbers.formatDecimal((product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1), 0, 'POINT', 2, 'COMMA')}">101.00</span>
                                    </small>
                                </div>                                <button type="button" class="btn btn-gold w-100" id="prepareBidBtn" 
                                        th:data-product-id="${product.id}"
                                        th:data-authenticated="${#authorization.expression('isAuthenticated()')}">
                                    <i class="fas fa-gavel me-2"></i>Dar Lance
                                </button>
                                
                                <!-- Mensagem para usuários não logados -->
                                <div sec:authorize="!isAuthenticated()" class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <a href="/login" class="alert-link">Faça login</a> para participar dos leilões!
                                </div>
                                
                                <!-- Quick bid buttons -->
                                <div class="mb-3">
                                    <small class="text-muted mb-2 d-block">Lance rápido:</small>
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-warning btn-sm quick-bid" 
                                                th:data-amount="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1)}">
                                            Mínimo
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm quick-bid" 
                                                th:data-amount="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1) + 5}">
                                            +$5
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm quick-bid" 
                                                th:data-amount="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1) + 10}">
                                            +$10
                                        </button>
                                        <button type="button" class="btn btn-outline-warning btn-sm quick-bid" 
                                                th:data-amount="${(product.price != null ? product.price : 0) + (product.minBidIncrement != null ? product.minBidIncrement : 1) + 25}">
                                            +$25
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Botão para comprar agora no leilão -->
                            <form th:if="${product.buyNowPrice != null and #authentication.name != product.seller.username}" 
                                  th:action="@{/item/{id}/comprar(id=${product.id})}" method="post" sec:authorize="isAuthenticated()">
                                <button type="submit" class="btn btn-gold w-100 mb-2">
                                    <i class="fas fa-shopping-cart me-2"></i>Comprar Agora
                                </button>
                            </form>
                            <!-- Modificar a seção de edição para incluir exclusão -->
                            <div th:if="${#authentication.name == product.seller.username}" class="d-grid gap-2 mt-2">
                                <a th:href="@{/item/{id}/editar(id=${product.id})}" 
                                   class="btn btn-outline-primary w-100 mb-2">
                                    <i class="fas fa-edit me-2"></i>Editar Item
                                </a>
                                
                                <!-- Botão para excluir o item -->
                                <form th:action="@{/item/{id}/excluir(id=${product.id})}" method="post" 
                                      onsubmit="return confirm('Tem certeza que deseja excluir este leilão? Esta ação não pode ser desfeita. Todos os lances serão cancelados.');">
                                    <!-- Adicionar token CSRF -->
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    
                                    <button type="submit" class="btn btn-danger w-100">
                                        <i class="fas fa-trash-alt me-2"></i>Encerrar e Excluir Leilão
                                    </button>
                                </form>
                            </div>
                            <!-- Alert para usuários não autenticados -->
                            <div sec:authorize="!isAuthenticated()" class="alert alert-info">
                                <a th:href="@{/login}" class="alert-link">Entre</a> ou 
                                <a th:href="@{/aventureiro/registrar}" class="alert-link">registre-se</a> para participar deste leilão.
                            </div>
                        </div>
                          <!-- Se o item já foi vendido -->
                        <div th:if="${product.status.name() == 'SOLD' or product.status.name() == 'AUCTION_ENDED'}" class="text-center mb-4">
                            <div class="alert alert-dark border-warning">
                                <div class="d-flex align-items-center justify-content-center mb-3">
                                    <i class="fas fa-shield-alt fs-2 me-3 text-warning"></i>
                                    <div class="text-start">
                                        <h5 class="mb-1 text-warning">Item vendido com sucesso!</h5>
                                        <small class="text-muted">
                                            <span th:if="${product.status.name() == 'SOLD'}">Venda direta concluída</span>
                                            <span th:if="${product.status.name() == 'AUCTION_ENDED'}">Leilão finalizado</span>
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="row text-center">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-1">Preço final</h6>
                                        <h4 class="text-success fw-bold" 
                                            th:text="${'$' + #numbers.formatDecimal(product.price, 0, 'POINT', 2, 'COMMA')}">
                                            $99.99
                                        </h4>
                                    </div>
                                    <div class="col-md-6" th:if="${product.createdAt}">
                                        <h6 class="text-muted mb-1">Data da venda</h6>
                                        <p class="mb-0 fw-bold" th:text="${#temporals.format(product.createdAt, 'dd/MM/yyyy')}">
                                            01/01/2024
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sugestões para usuários não proprietários -->
                            <div th:unless="${isOwner}" class="mt-4">
                                <div class="alert alert-info">
                                    <h6 class="mb-2"><i class="fas fa-lightbulb me-2"></i>Interessado em itens similares?</h6>
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <a th:href="@{/mercado/categoria/{category}(category=${product.category})}" 
                                           class="btn btn-outline-primary btn-sm" 
                                           th:if="${product.category}">
                                            <i class="fas fa-tags me-1"></i>Ver mais <span th:text="${product.category.displayName}">categoria</span>
                                        </a>
                                        <a href="/mercado" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-store me-1"></i>Explorar marketplace
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Opções para o vendedor -->
                            <div th:if="${isOwner}" class="mt-4">
                                <div class="alert alert-success">
                                    <h6 class="mb-2"><i class="fas fa-trophy me-2"></i>Parabéns pela venda!</h6>
                                    <p class="mb-3 text-sm">Este item foi vendido com sucesso. Você pode gerenciar seus anúncios no seu inventário.</p>
                                    
                                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                                        <a href="/aventureiro/inventario" class="btn btn-outline-success btn-sm">
                                            <i class="fas fa-box me-1"></i>Ver meu inventário
                                        </a>
                                        <a href="/aventureiro/vendas" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-chart-line me-1"></i>Minhas vendas
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Botão para remover do histórico -->
                                <form th:action="@{/item/{id}/excluir(id=${product.id})}" method="post" class="mt-3"
                                      onsubmit="return confirm('Tem certeza que deseja remover este item do seu histórico? Esta ação não pode ser desfeita.');">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash-alt me-2"></i>Remover do histórico
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Histórico de Lances -->
                <div th:if="${product.type.name() == 'AUCTION' and bids != null and !#lists.isEmpty(bids)}" class="card border-gold mt-3">
                    <div class="card-header bg-dark text-light">
                        <h3 class="rpg-font mb-0">
                            <i class="fas fa-history me-2"></i>Histórico de Lances
                        </h3>
                    </div>
                    <div class="card-body p-0">
                        <ul class="list-group list-group-flush bid-history">
                            <li th:each="bid : ${bids}" class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold text-primary" th:text="${bid.bidder.username}">Usuário</span>
                                    <span class="ms-2 badge bg-secondary">
                                        <i class="fas fa-user-tag me-1"></i>Licitante
                                    </span>
                                </div>
                                <span class="badge bg-success fs-6" 
                                      th:text="${'$' + #numbers.formatDecimal(bid.amount, 0, 'POINT', 2, 'COMMA')}">
                                    $99.99
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div> <!-- Fim col-lg-4 -->
        </div> <!-- Fim row -->
    </div>
    
    <!-- Modal de Confirmação de Lance - Tema RPG -->
    <div class="modal fade" id="bidConfirmationModal" tabindex="-1" aria-labelledby="bidConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-gold" style="background: linear-gradient(135deg, #2c1810 0%, #3d2817 100%); border: 2px solid #FFD700;">
                <div class="modal-header" style="border-bottom: 1px solid #FFD700; background: rgba(255, 215, 0, 0.1);">
                    <h5 class="modal-title rpg-font text-gold" id="bidConfirmationModalLabel">
                        <i class="fas fa-gavel me-2"></i>Confirmar Lance
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="mb-4">
                        <i class="fas fa-coins text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                    </div>
                    <h4 class="text-gold mb-3">Deseja confirmar seu lance?</h4>
                    <div class="alert alert-warning border-gold" style="background: rgba(255, 215, 0, 0.1); border-color: #FFD700;">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <small class="text-muted">Valor do Lance:</small>
                                <div class="h4 text-success mb-0" id="modalBidAmount">$0.00</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Item:</small>
                                <div class="fw-bold text-gold" th:text="${product.name}">Item Name</div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info border-info" style="background: rgba(0, 123, 255, 0.1);">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>Lembre-se: Os lances são irreversíveis! Certifique-se do valor antes de confirmar.</small>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #FFD700; background: rgba(255, 215, 0, 0.05);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-gold" id="confirmBidButton">
                        <i class="fas fa-gavel me-2"></i>Confirmar Lance
                    </button>
                </div>
            </div>
        </div>    </div>

    </div> <!-- Fim layout:fragment="content" -->

    <th:block layout:fragment="pageScripts"><script th:if="${product.type.name() == 'AUCTION' and product.status.name() == 'AUCTION_ACTIVE'}">
            document.addEventListener('DOMContentLoaded', function() {
                // Obtém o elemento que contém a data final do leilão
                const endDateElement = document.getElementById('endDate');
                if (!endDateElement) return;

                // Cria um objeto Date usando o valor do elemento
                const endDate = new Date(endDateElement.value);
                
                // Obtém o elemento onde o tempo restante será exibido
                const countdownElement = document.getElementById('countdown');
                
                // Inicia um intervalo que chama a função updateCountdown
                const interval = setInterval(updateCountdown, 1000);
                
                function updateCountdown() {
                    const now = new Date();
                    const diff = endDate - now;
                    
                    if (diff <= 0) {
                        countdownElement.textContent = "Leilão Encerrado";
                        clearInterval(interval);
                        return;
                    }
                    
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    let displayText = "";
                    if (days > 0) { 
                        displayText += days + "d ";
                    }
                    displayText += hours + "h " + minutes + "m " + seconds + "s";
                    
                    countdownElement.textContent = displayText;
                }
                
                updateCountdown();
                
                // Auto-refresh bid information every 30 seconds
                setInterval(function() {
                    refreshBidInfo();
                }, 30000);
                
                function refreshBidInfo() {
                    fetch(window.location.href, {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Update current bid price
                        const newPriceElement = doc.querySelector('.product-price');
                        const currentPriceElement = document.querySelector('.product-price');
                        if (newPriceElement && currentPriceElement) {
                            const newPrice = newPriceElement.textContent;
                            const currentPrice = currentPriceElement.textContent;
                            
                            if (newPrice !== currentPrice) {
                                currentPriceElement.textContent = newPrice;
                                
                                // Add visual feedback for updated price
                                currentPriceElement.style.animation = 'pulse 1s';
                                setTimeout(() => {
                                    currentPriceElement.style.animation = '';
                                }, 1000);
                            }
                        }
                        
                        // Update bid history
                        const newBidHistory = doc.querySelector('.bid-history');
                        const currentBidHistory = document.querySelector('.bid-history');
                        if (newBidHistory && currentBidHistory) {
                            currentBidHistory.innerHTML = newBidHistory.innerHTML;
                        }
                        
                        // Update minimum bid amount in form
                        const newBidForm = doc.querySelector('input[name="amount"]');
                        const currentBidForm = document.querySelector('input[name="amount"]');
                        if (newBidForm && currentBidForm) {
                            currentBidForm.min = newBidForm.min;
                            currentBidForm.value = newBidForm.value;
                        }
                    })
                    .catch(error => {
                        console.log('Erro ao atualizar informações dos lances:', error);
                    });                }
            });
        </script>        <!-- Script unificado para controle do sistema de lances -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                console.log('Inicializando sistema de lances...');
                
                // Inicializar elementos e configurar eventos
                initializeBidding();
                
                function initializeBidding() {
                    // Verificar se estamos em uma página de leilão
                    const bidForm = document.querySelector('.bid-form');
                    const bidAmountInput = document.getElementById('bidAmount');
                    
                    if (!bidForm || !bidAmountInput) {
                        console.log('Não é uma página de leilão, saltando inicialização dos lances');
                        return;
                    }
                    
                    // Garantir que o botão "Dar Lance" existe
                    ensureBidButtonExists();
                    
                    // Configurar todos os event listeners
                    setupAllEventListeners();
                    
                    // Configurar atualizações automáticas se necessário
                    setupAutoRefresh();
                    
                    // Processar mensagens de feedback
                    processUrlMessages();
                }
                
                function ensureBidButtonExists() {
                    let prepareBidBtn = document.getElementById('prepareBidBtn');
                    
                    // Se o botão não existe, criar dinamicamente
                    if (!prepareBidBtn) {
                        console.log('Botão "Dar Lance" não encontrado, criando...');
                        
                        const productId = getProductId();
                        const bidForm = document.querySelector('.bid-form');
                        
                        if (productId && bidForm) {
                            prepareBidBtn = document.createElement('button');
                            prepareBidBtn.type = 'button';
                            prepareBidBtn.className = 'btn btn-gold w-100 mb-3';
                            prepareBidBtn.id = 'prepareBidBtn';
                            prepareBidBtn.setAttribute('data-product-id', productId);
                            prepareBidBtn.innerHTML = '<i class="fas fa-gavel me-2"></i>Dar Lance';
                            
                            // Inserir após o input-group
                            const inputGroup = bidForm.querySelector('.input-group');
                            if (inputGroup) {
                                inputGroup.parentNode.insertBefore(prepareBidBtn, inputGroup.nextSibling);
                            }
                            
                            console.log('Botão "Dar Lance" criado com sucesso');
                        }
                    }
                    
                    return prepareBidBtn;
                }
                
                function getProductId() {
                    // Primeiro, tentar obter do URL
                    const urlParts = window.location.pathname.split('/');
                    if (urlParts.length >= 3 && urlParts[1] === 'item') {
                        return urlParts[2];
                    }
                    
                    // Segundo, procurar em elementos com data-product-id
                    const elementWithProductId = document.querySelector('[data-product-id]');
                    if (elementWithProductId) {
                        return elementWithProductId.getAttribute('data-product-id');
                    }
                    
                    console.warn('Product ID não encontrado');
                    return null;
                }
                
                function setupAllEventListeners() {
                    // Configurar botões de lance rápido
                    setupQuickBidButtons();
                    
                    // Configurar botão principal de lance
                    setupMainBidButton();
                }
                
                function setupQuickBidButtons() {
                    const quickBidButtons = document.querySelectorAll('.quick-bid');
                    const bidAmountInput = document.getElementById('bidAmount');
                    
                    quickBidButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            const amount = this.getAttribute('data-amount');
                            if (bidAmountInput && amount) {
                                bidAmountInput.value = amount;
                                
                                // Feedback visual
                                this.classList.add('active');
                                setTimeout(() => this.classList.remove('active'), 200);
                            }
                        });
                    });
                    
                    console.log(`Configurados ${quickBidButtons.length} botões de lance rápido`);
                }
                
                function setupMainBidButton() {
                    const prepareBidBtn = document.getElementById('prepareBidBtn');
                    const bidAmountInput = document.getElementById('bidAmount');
                    
                    if (!prepareBidBtn || !bidAmountInput) {
                        console.log('Elementos necessários para lance não encontrados');
                        return;
                    }
                    
                    // Remover listeners anteriores se existirem
                    const newBtn = prepareBidBtn.cloneNode(true);
                    prepareBidBtn.parentNode.replaceChild(newBtn, prepareBidBtn);
                    
                    // Adicionar novo listener
                    newBtn.addEventListener('click', function() {
                        handleBidSubmission();
                    });
                    
                    console.log('Event listener do botão principal configurado');
                }
                  function handleBidSubmission() {
                    const bidAmountInput = document.getElementById('bidAmount');
                    const productId = getProductId();
                    const amount = bidAmountInput ? bidAmountInput.value : null;
                    
                    // Verificar se o usuário está autenticado
                    const prepareBidBtn = document.getElementById('prepareBidBtn');
                    const isAuthenticated = prepareBidBtn ? prepareBidBtn.getAttribute('data-authenticated') === 'true' : false;
                    
                    if (!isAuthenticated) {
                        showNotification('Você precisa fazer login para dar lances. Redirecionando...', 'warning');
                        setTimeout(() => {
                            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                        }, 2000);
                        return;
                    }
                    
                    // Validações
                    if (!productId) {
                        showNotification('Erro: ID do produto não encontrado', 'danger');
                        return;
                    }
                    
                    if (!amount || parseFloat(amount) <= 0) {
                        showNotification('Por favor, insira um valor válido para o lance', 'warning');
                        bidAmountInput?.focus();
                        return;
                    }
                      // Mostrar modal de confirmação
                    showBidConfirmationModal(amount, productId);
                }
                
                function submitBid(productId, amount) {
                    // Criar formulário dinamicamente
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/lance/dar';
                    form.style.display = 'none';
                    
                    // Campo produto
                    const productIdField = document.createElement('input');
                    productIdField.type = 'hidden';
                    productIdField.name = 'productId';
                    productIdField.value = productId;
                    form.appendChild(productIdField);
                    
                    // Campo valor
                    const amountField = document.createElement('input');
                    amountField.type = 'hidden';
                    amountField.name = 'amount';
                    amountField.value = amount;
                    form.appendChild(amountField);
                    
                    // CSRF Token
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    if (csrfToken) {
                        const csrfField = document.createElement('input');
                        csrfField.type = 'hidden';
                        csrfField.name = '_csrf';
                        csrfField.value = csrfToken;
                        form.appendChild(csrfField);
                    }
                    
                    // Enviar
                    document.body.appendChild(form);
                    
                    console.log('Enviando lance:', { productId, amount });
                    form.submit();
                }
                
                function setupAutoRefresh() {
                    // Auto-refresh a cada 30 segundos se for leilão ativo
                    const isAuctionActive = document.querySelector('.badge.bg-warning');
                    if (isAuctionActive) {
                        setInterval(refreshBidInfo, 30000);
                    }
                }
                
                function refreshBidInfo() {
                    fetch(window.location.href, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Atualizar preço atual
                        const newPrice = doc.querySelector('.product-price');
                        const currentPrice = document.querySelector('.product-price');
                        
                        if (newPrice && currentPrice && newPrice.textContent !== currentPrice.textContent) {
                            currentPrice.textContent = newPrice.textContent;
                            currentPrice.style.animation = 'pulse 1s';
                            setTimeout(() => currentPrice.style.animation = '', 1000);
                        }
                        
                        // Atualizar histórico de lances
                        const newBidHistory = doc.querySelector('.bid-history');
                        const currentBidHistory = document.querySelector('.bid-history');
                        if (newBidHistory && currentBidHistory) {
                            currentBidHistory.innerHTML = newBidHistory.innerHTML;
                        }
                    })
                    .catch(error => console.log('Erro ao atualizar informações:', error));
                }
                
                // Função para mostrar notificações
                function showNotification(message, type = 'info') {
                    // Remove notificações existentes
                    const existingNotifications = document.querySelectorAll('.notification-alert');
                    existingNotifications.forEach(n => n.remove());
                    
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed notification-alert`;
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px; max-width: 400px;';
                    
                    const icon = type === 'success' ? 'check-circle' : 
                                type === 'danger' ? 'exclamation-triangle' : 
                                type === 'warning' ? 'exclamation-circle' : 'info-circle';
                    
                    notification.innerHTML = `
                        <i class="fas fa-${icon} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Auto remove after 5 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 5000);
                }
                
                // Verificar mensagens de sucesso/erro da URL
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('success')) {
                    showNotification('🎉 Lance registrado com sucesso!', 'success');
                    
                    // Refresh page after a moment
                    setTimeout(() => {
                        window.location.href = window.location.pathname;
                    }, 2000);
                }
                
                if (urlParams.get('error')) {
                    showNotification('❌ ' + decodeURIComponent(urlParams.get('error')), 'danger');
                }                // Função para mostrar modal de confirmação (com validação prévia no servidor)
                function showBidConfirmationModal(amount, productId) {
                    console.log('showBidConfirmationModal chamada:', { amount, productId });
                    
                    // Primeiro, validar no servidor se o lance é permitido
                    const formData = new FormData();
                    formData.append('productId', productId);
                    formData.append('amount', amount);
                    
                    // Adicionar token CSRF
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                    if (csrfToken) {
                        formData.append('_csrf', csrfToken);
                    }
                    
                    // Fazer requisição de preparação do lance
                    fetch('/bid/prepare', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Resposta da preparação:', data);
                        
                        if (!data.success) {
                            // Erro de validação - mostrar mensagem na tela
                            console.log('Erro de validação:', data.error);
                            showNotification('⚠️ ' + data.error, 'warning');
                            return;
                        }
                        
                        // Validação passou - continuar com modal original
                        showActualBidModal(amount, productId, data);
                    })
                    .catch(error => {
                        console.error('Erro na validação do lance:', error);
                        showNotification('❌ Erro ao validar lance. Tente novamente.', 'danger');
                    });
                }
                  // Função original do modal (renomeada)
                function showActualBidModal(amount, productId, validationData) {
                    console.log('showActualBidModal chamada:', { amount, productId, validationData });
                    
                    // Tentar encontrar o modal existente ou criar um novo
                    let modalElement = document.getElementById('bidConfirmationModal');
                    
                    // Se não existe, criar dinamicamente
                    if (!modalElement) {
                        console.log('Modal não encontrado, criando dinamicamente...');
                        modalElement = createDynamicBidModal();
                        
                        if (!modalElement) {
                            console.error('Falha ao criar modal dinâmico. Using simple confirm.');
                            if (confirm(`Confirma o lance de $${parseFloat(amount).toFixed(2)}?`)) {
                                submitBid(productId, amount);
                            }
                            return;
                        }
                    }
                    
                    // Verificar se Bootstrap está disponível
                    if (typeof bootstrap === 'undefined') {
                        console.error('Bootstrap não está carregado. Using simple confirm.');
                        if (confirm(`Confirma o lance de $${parseFloat(amount).toFixed(2)}?`)) {
                            submitBid(productId, amount);
                        }
                        return;
                    }
                    
                    try {
                        // Atualizar o valor no modal
                        const modalBidAmount = modalElement.querySelector('#modalBidAmount');
                        if (modalBidAmount) {
                            modalBidAmount.textContent = `$${parseFloat(amount).toFixed(2)}`;
                            console.log('Valor atualizado no modal:', modalBidAmount.textContent);
                        } else {
                            console.warn('modalBidAmount element not found');
                        }
                        
                        // Atualizar nome do produto no modal
                        const modalProductName = modalElement.querySelector('.fw-bold.text-gold');
                        const productNameElement = document.querySelector('h1.rpg-font');
                        if (modalProductName && productNameElement) {
                            modalProductName.textContent = productNameElement.textContent;
                        }
                        
                        // Mostrar informações da validação se disponível
                        if (validationData && validationData.message) {
                            const messageElement = modalElement.querySelector('.modal-body p');
                            if (messageElement) {
                                messageElement.textContent = validationData.message;
                            }
                        }
                        
                        // Configurar o botão de confirmação
                        const confirmButton = modalElement.querySelector('#confirmBidButton');
                        if (confirmButton) {
                            // Limpar listeners anteriores
                            const newButton = confirmButton.cloneNode(true);
                            confirmButton.parentNode.replaceChild(newButton, confirmButton);
                            
                            // Adicionar novo listener
                            newButton.addEventListener('click', function() {
                                console.log('Botão confirmar clicado');
                                
                                // Fechar modal
                                try {
                                    const modal = bootstrap.Modal.getInstance(modalElement);
                                    if (modal) {
                                        modal.hide();
                                    } else {
                                        // Fallback manual para fechar modal
                                        modalElement.classList.remove('show');
                                        modalElement.style.display = 'none';
                                        modalElement.setAttribute('aria-hidden', 'true');
                                        document.body.classList.remove('modal-open');
                                        const backdrop = document.querySelector('.modal-backdrop');
                                        if (backdrop) backdrop.remove();
                                    }
                                } catch (e) {
                                    console.error('Erro ao fechar modal:', e);
                                }
                                
                                // Enviar lance
                                console.log('Enviando lance...');
                                submitBid(productId, amount);
                            });
                            
                            console.log('Event listener configurado no botão confirmar');
                        } else {
                            console.error('confirmBidButton element not found');
                        }
                        
                        // Mostrar modal
                        console.log('Tentando mostrar modal...');
                        const modal = new bootstrap.Modal(modalElement, {
                            backdrop: 'static',
                            keyboard: false
                        });
                        modal.show();
                        console.log('Modal mostrado com sucesso');
                        
                    } catch (error) {
                        console.error('Erro completo ao mostrar modal:', error);
                        console.error('Stack trace:', error.stack);
                        
                        // Fallback para confirmação simples
                        if (confirm(`Confirma o lance de $${parseFloat(amount).toFixed(2)}?`)) {
                            submitBid(productId, amount);
                        }
                    }
                }
                
                // Função para criar modal dinâmico caso o HTML não seja renderizado
                function createDynamicBidModal() {
                    console.log('Criando modal dinâmico...');
                    
                    try {
                        // HTML do modal
                        const modalHTML = `
                            <div class="modal fade" id="bidConfirmationModal" tabindex="-1" aria-labelledby="bidConfirmationModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content border-gold" style="background: linear-gradient(135deg, #2c1810 0%, #3d2817 100%); border: 2px solid #FFD700;">
                                        <div class="modal-header" style="border-bottom: 1px solid #FFD700; background: rgba(255, 215, 0, 0.1);">
                                            <h5 class="modal-title rpg-font text-gold" id="bidConfirmationModalLabel">
                                                <i class="fas fa-gavel me-2"></i>Confirmar Lance
                                            </h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body text-center py-4">
                                            <div class="mb-4">
                                                <i class="fas fa-coins text-warning" style="font-size: 3rem; margin-bottom: 15px;"></i>
                                            </div>
                                            <h4 class="text-gold mb-3">Deseja confirmar seu lance?</h4>
                                            <div class="alert alert-warning border-gold" style="background: rgba(255, 215, 0, 0.1); border-color: #FFD700;">
                                                <div class="row align-items-center">
                                                    <div class="col-6">
                                                        <small class="text-muted">Valor do Lance:</small>
                                                        <div class="h4 text-success mb-0" id="modalBidAmount">$0.00</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">Item:</small>
                                                        <div class="fw-bold text-gold">Item em Leilão</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="alert alert-info border-info" style="background: rgba(0, 123, 255, 0.1);">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <small>Lembre-se: Os lances são irreversíveis! Certifique-se do valor antes de confirmar.</small>
                                            </div>
                                        </div>
                                        <div class="modal-footer" style="border-top: 1px solid #FFD700; background: rgba(255, 215, 0, 0.05);">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                <i class="fas fa-times me-2"></i>Cancelar
                                            </button>
                                            <button type="button" class="btn btn-gold" id="confirmBidButton">
                                                <i class="fas fa-gavel me-2"></i>Confirmar Lance
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Criar div temporária para inserir o HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = modalHTML;
                        
                        // Extrair o modal element
                        const modalElement = tempDiv.firstElementChild;
                        
                        // Adicionar ao body
                        document.body.appendChild(modalElement);
                        
                        console.log('Modal dinâmico criado e adicionado ao DOM');
                        return modalElement;
                        
                    } catch (error) {
                        console.error('Erro ao criar modal dinâmico:', error);
                        return null;
                    }
                }
                
                // Função para processar mensagens da URL
                function processUrlMessages() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    if (urlParams.get('success')) {
                        showNotification('🎉 Lance registrado com sucesso!', 'success');
                        
                        // Refresh page after a moment to show updated bid
                        setTimeout(() => {
                            window.location.href = window.location.pathname;
                        }, 2000);
                    }
                    
                    if (urlParams.get('error')) {
                        const errorMsg = decodeURIComponent(urlParams.get('error'));
                        showNotification('❌ ' + errorMsg, 'danger');
                    }
                }
            });
        </script>
          <!-- CSS melhorado para botões de lance -->
        <style>
            .btn-gold:disabled {
                background-color: #6b7280 !important;
                border-color: #6b7280 !important;
                color: #ffffff !important;
                cursor: not-allowed;
            }
            
            .quick-bid.active {
                background-color: #f59e0b !important;
                color: #1a1a1a !important;
                border-color: #f59e0b !important;
                transform: scale(0.95);
                transition: all 0.1s ease;
            }
            
            .notification-alert {
                animation: slideInRight 0.3s ease-out;
            }
            
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            /* Estilos específicos para modais dinâmicos */
            #bidConfirmationModal .text-gold {
                color: #FFD700 !important;
            }
            
            #bidConfirmationModal .border-gold {
                border-color: #FFD700 !important;
            }
            
            #bidConfirmationModal .btn-gold {
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                border: none;
                color: #000;
                font-weight: bold;
                transition: all 0.3s ease;
            }
            
            #bidConfirmationModal .btn-gold:hover {
                background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
                color: #000;
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            }
              #bidConfirmationModal .rpg-font {
                font-family: 'Cinzel', 'Times New Roman', serif;
                font-weight: 600;
            }
        </style>
        
        <script>
            // ===== SISTEMA DE MODAL DE IMAGENS =====
            function openImageModal(imgElement) {
                // Não abrir modal para imagem padrão
                if (imgElement.src.includes('default-product.jpg')) {
                    return;
                }
                
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                
                modal.style.display = 'block';
                modalImg.src = imgElement.getAttribute('data-full-image') || imgElement.src;
                
                // Fechar modal ao clicar fora da imagem
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        closeImageModal();
                    }
                }
            }
            
            function closeImageModal() {
                document.getElementById('imageModal').style.display = 'none';
            }
            
            // Fechar modal com ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeImageModal();
                }
            });
        </script>
        
        <!-- Modal de Imagem -->
        <div id="imageModal" class="image-modal">
            <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
            <div class="image-modal-content">
                <img id="modalImage" src="" alt="Imagem do Produto">
            </div>
        </div>
    </th:block>
</body>
</html>